DISCORD MESSAGE PULL FEATURE - IMPLEMENTATION PLAN
==================================================

BRANCH: amp/support-discord-message-pull
STATUS: IN PROGRESS - Testing Discord API integration

OVERVIEW
--------
Add ability to pull PCAP files directly from Discord message attachments without leaking OAuth token to browser.

ARCHITECTURE
-----------
Before: Static WASM app (nginx) + User's OAuth token in URL query param
After:  Rust backend (Axum) + Static WASM frontend + Server-side Discord API calls

Components:
1. crates/web-server/ - New Axum HTTP server (replaces nginx)
2. crates/app/ - Updated WASM frontend with Discord UI
3. Dockerfile - Multi-stage build (Rust server + Node/WASM assets)
4. .envrc/.envrc.local - Environment setup with DISCORD_OAUTH_TOKEN

COMPLETED
---------
âœ… Created crates/web-server with Axum framework
  - /api/health endpoint for health checks
  - /api/discord endpoint skeleton
  - Static file serving from dist/ directory
  - Environment variable checking for DISCORD_OAUTH_TOKEN

âœ… Implemented Discord API module (crates/web-server/src/discord.rs)
  - fetch_message() - Calls Discord API v10 to get message details
  - download_attachment() - Downloads PCAP from Discord CDN
  - Snowflake ID validation (18-digit format)
  - PCAP file extension validation (.pcap, .pcapng)
  - Size limits (100 MB max)
  - Error handling (404, 403, etc.)

âœ… Updated Dockerfile for multi-stage build
  - Stage 1: Build Rust server binary
  - Stage 2: Build web assets (WASM)
  - Stage 3: Runtime with both

âœ… Updated WASM app (crates/app/)
  - Added discord_channel_id and discord_message_id fields to app state
  - Added UI controls for Discord channel/message input
  - Implemented load_from_discord() function
  - Added fetch_discord_pcap() for calling /api/discord endpoint

âœ… Fixed scrubber highlighting for hex searches (separate PR #56)
  - Uses consistent filter logic across table, highlights, and marking

IN PROGRESS
-----------
ðŸ”„ Testing Discord API endpoint
  - Web server builds and starts successfully
  - Health check endpoint works (/api/health returns "OK")
  - Query parameter parsing FIXED (was user error with URL encoding)
  - Snowflake ID validation working (18-digit check)
  - Discord API call attempt successful (getting 401 Unauthorized)
    * This means the OAuth token provided is invalid/expired
    * The implementation is correct - proper API call being made
    * Error handling improved with detailed error messages

FIXED ISSUES
------------
âœ… Query parameter parsing
  - Was actually working, just needed proper URL encoding
  - Test: curl "http://localhost:3000/api/discord?channel=ID&msg=ID"
  
âœ… Router configuration
  - Changed from nest_service to fallback_service for root route
  - Allows proper routing of /api/* endpoints while serving static files

âœ… Error logging
  - Added Discord API response body logging for debugging
  - Added specific handling for 401 authentication failures
  - Better error messages to clients

Test Commands:
  1. Build web assets: cargo xtask web
  2. Copy to dist: cp -r crates/web/pkg/* dist/
  3. Set token: source .envrc.local
  4. Run server: ./target/debug/web-server
  5. Test health: curl http://localhost:3000/api/health
  6. Test Discord: curl "http://localhost:3000/api/discord?channel=138001967583592463&msg=144100294560789713"

REMAINING WORK
--------------
1. âœ… DONE - Query parameter parsing
   - Fixed with proper URL encoding
   - Snowflake ID validation working

2. ðŸ”„ IN PROGRESS - Test Discord API integration
   - Need valid Discord bot token to test
   - Once token is available:
     * Test message fetching
     * Test attachment downloading
     * Test PCAP validation
   - Current status: Getting 401 with provided token (invalid/expired)

3. Integrate with web UI
   - Test full flow: UI â†’ server â†’ Discord API â†’ PCAP returned
   - Handle error cases gracefully
   - Show loading spinner during fetch
   - Test in browser with real Discord message

4. Rate limiting
   - Add middleware to limit Discord API requests per IP
   - Implement exponential backoff for Discord API timeouts
   - Prevent DOS attacks on endpoint

5. Production readiness
   - Proper CORS headers for web requests
   - Request validation and input sanitization
   - Structured logging with request IDs
   - Health check endpoint monitoring
   - Graceful shutdown handling

6. Documentation
   - Update README with Discord feature
   - Document how to create Discord bot token
   - Document .envrc.local setup
   - Document deployment with Docker
   - Add usage examples

ENVIRONMENT SETUP
-----------------
.envrc - Template that sources .envrc.local (not committed)
.envrc.local - Contains actual Discord OAuth token (in .gitignore)

Token setup:
  1. Create .envrc.local with: export DISCORD_OAUTH_TOKEN="your-bot-token"
  2. Run: direnv allow
  3. Token is automatically loaded when entering directory

TESTING DETAILS
---------------
Test channel: 1380019675835924631
Test message with PCAP: Check Discord server

Example URL format after implementation:
  ?discord=channel:1234567890&msg=9876543210
  Server returns: binary PCAP data

ERROR HANDLING
--------------
Discord API returns:
- 404: Message not found
- 403: Access denied (user can't see channel/message)
- 200: Success (message found)

Server returns to client:
- 200: Binary PCAP data with Content-Type: application/octet-stream
- 400: Invalid channel/msg IDs or no PCAP attachment
- 401: Token not configured
- 404: Message not found
- 403: Access denied
- 500: Internal server error

FILES MODIFIED
--------------
crates/web-server/src/main.rs - Main server file
crates/web-server/src/discord.rs - Discord API integration
crates/web-server/Cargo.toml - Dependencies (axum, reqwest, etc.)
crates/app/src/lib.rs - Added Discord UI state and fields
crates/app/src/ui/file_panel.rs - Added load_from_discord() function
Dockerfile - Multi-stage build
.envrc - Environment template
.gitignore - Added .envrc.local

GIT COMMITS
-----------
1. "feat: Add Axum web server with Discord API endpoint skeleton"
2. "feat: Implement Discord API integration for PCAP fetching"
3. "feat: Add Discord PCAP loading to web UI"

NEXT STEPS (Priority Order)
----------------------------
1. Fix query parameter parsing issue (BLOCKER)
2. Test Discord API with real credentials
3. Implement retry logic for Discord API timeouts
4. Add integration tests
5. Update documentation
6. Create PR with full implementation
